<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Audio Player</title>
  <style>
    body {
      margin: 0;
      background-color: black;
    }
    .player {
      width: 940px;
      height: 128px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 20px 10px black;
      display: none;
    }
  </style>
</head>
<body>

<!-- Tady se budou vkládat playery -->
<div id="playerContainer"></div>

<script>
  const container = document.getElementById('playerContainer');
  const PRIMARY_URL = "https://fmcloud.pro/embed.php?id=347&autoplay=true";
  const BACKUP_URL = "https://trolltrolli.github.io/skt/popis/hl2/player_backup.html";
  let iframe, fallbackTriggered = false;

  function loadIframe(src) {
    iframe = document.createElement('iframe');
    iframe.src = src;
    iframe.allow = "autoplay";
    iframe.className = "player";
    iframe.style.display = 'block';

    iframe.onload = () => {
      console.log("Iframe načten:", src);
      // Zkusíme navíc detekovat zvuk
      detectAudioPlayback();
    };

    container.appendChild(iframe);
  }

  function switchToBackup(reason) {
    if (fallbackTriggered) return;
    fallbackTriggered = true;
    console.warn("Přepínám na záložní přehrávač – důvod:", reason);
    container.innerHTML = "";
    loadIframe(BACKUP_URL);
  }

  function detectAudioPlayback() {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      // Detekujeme výstupní zvuk v systému (ne přímo z iframe, protože nelze propojit z cizí domény)
      const checkSilence = () => {
        analyser.getByteFrequencyData(dataArray);
        let sum = dataArray.reduce((a, b) => a + b, 0);
        if (sum > 1000) {
          console.log("Zvuk detekován.");
        } else {
          console.warn("Žádný zvuk nedetekován, přepínám.");
          switchToBackup("Žádný zvuk");
        }
      };

      // Zkusit získat výstupní media stream
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const source = audioCtx.createMediaStreamSource(stream);
          source.connect(analyser);
          setTimeout(checkSilence, 3000);
        })
        .catch(err => {
          console.error("Nelze detekovat zvuk:", err);
          switchToBackup("Chyba audio streamu");
        });
    } catch (e) {
      console.error("AudioContext selhal:", e);
      switchToBackup("Chyba Audio API");
    }
  }

  function startPlayer() {
    loadIframe(PRIMARY_URL);

    // Timeout pokud se iframe nenačte vůbec (do 5 sekund)
    setTimeout(() => {
      if (!iframe || iframe.contentWindow.length === 0) {
        switchToBackup("Timeout - iframe se nenačetl");
      }
    }, 5000);
  }

  // Start
  startPlayer();
</script>

</body>
</html>
